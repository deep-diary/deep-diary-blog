(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{662:function(s,a,t){"use strict";t.r(a);var e=t(5),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("说明")]),s._v(" "),t("p",[s._v("用户访问网址的时候，往往需要快速响应，比如200ms。但是，实际过程中，涉及到上传图片，人脸识别，同步数据到mcs等一些耗时的操作，就是造成io 堵塞，导致用户等待过长的不良体验，因此，需要使用异步消息队列，处理这个问题")]),s._v(" "),t("p",[t("a",{attrs:{href:"www.deep-diary.com"}},[s._v("点击免费观看教学视频")])])]),s._v(" "),t("h1",{attrs:{id:"django-异步任务处理"}},[s._v("Django 异步任务处理")]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://www.cnblogs.com/pyedu/p/12461819.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("牛哄哄的celery - Mr·Yuan - 博客园 (cnblogs.com)"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/kk123a/article/details/74549117",target:"_blank",rel:"noopener noreferrer"}},[s._v("celery配置使用_kk123a的博客-CSDN博客_celery配置"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"celery-异步任务"}},[s._v("Celery 异步任务")]),s._v(" "),t("p",[s._v("版本")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("redis                         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.3")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".4")]),s._v("\ncelery                        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.2")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".7")]),s._v("\n\ncelery"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("redis             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 弃用")]),s._v("\ndjango"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("redis                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.2")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),s._v("\n\neventlet\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.33")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动定时器")]),s._v("\ncelery "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A deep_diary beat\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动异步任务")]),s._v("\ncelery "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A deep_diary worker "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("loglevel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("P eventlet\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("h3",{attrs:{id:"启动redis服务"}},[s._v("启动redis服务")]),s._v(" "),t("h4",{attrs:{id:"win10-下安装redis"}},[s._v("win10 下安装redis")]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://blog.csdn.net/c_lanxiaofang/article/details/108373920",target:"_blank",rel:"noopener noreferrer"}},[s._v("Windows10下 Redis在Django中的使用_懒笑翻的博客-CSDN博客"),t("OutboundLink")],1)])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("安装命令：redis-server.exe --service-install redis.windows.conf --loglevel verbose\n \n启动服务命令：redis-server.exe  --service-start\n \n关闭服务命令：redis-server.exe  --service-stop\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h4",{attrs:{id:"客户端联系redis服务"}},[s._v("客户端联系redis服务")]),s._v(" "),t("p",[s._v("need enter the redis intall folder to active this cmd")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("D:"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Program Files"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("Redis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("redis-cli.exe -h "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1 -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h4",{attrs:{id:"redis-使用"}},[s._v("redis 使用")]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://blog.csdn.net/jiandanokok/article/details/109426427",target:"_blank",rel:"noopener noreferrer"}},[s._v("【Django】Redis的使用【原创】_jiandanokok的博客-CSDN博客"),t("OutboundLink")],1)])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("删除所有Key，可以使用Redis的flushdb和flushall命令\n\n//删除当前数据库中的所有Key\nflushdb\n//删除所有数据库中的key\nflushall\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h3",{attrs:{id:"安装中间人broker-我们使用redis作为中间人"}},[s._v("安装中间人"),t("code",[s._v("broker")]),s._v("，我们使用"),t("code",[s._v("redis")]),s._v("作为中间人")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("pip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis 版本不能太高")]),s._v("\npip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" celery\npip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" celery-with-redis\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"在setting中配置celery"}},[s._v("在"),t("code",[s._v("setting")]),s._v("中配置celery")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置celery")]),s._v("\nBROKER_URL "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://localhost:6379/0'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置用户存储结果")]),s._v("\nCELER_RESULT_BACKEND "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://localhost:6379/0'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接超时")]),s._v("\nBROKER_TRANSPORT_OPTIONS "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'visibility_timeout'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3600")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("......")]),s._v(" "),t("h3",{attrs:{id:"在项目中配置celery"}},[s._v("在项目中配置"),t("code",[s._v("celery")])]),s._v(" "),t("p",[s._v("新增一个"),t("code",[s._v("celery.py")]),s._v("，配置celery作为单独的线程")]),s._v(" "),t("h4",{attrs:{id:"在项目的同名文件夹下新建一个celery同名文件夹"}},[s._v("在项目的同名文件夹下新建一个"),t("code",[s._v("celery")]),s._v("同名文件夹")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/image-20220904142117018.png",alt:"image-20220904142117018"}})]),s._v(" "),t("h4",{attrs:{id:"在-init-py中导入celery"}},[s._v("在__init__.py中导入"),t("code",[s._v("celery")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/image-20220904142615869.png",alt:"image-20220904142615869"}})]),s._v(" "),t("h3",{attrs:{id:"在应用中定义任务"}},[s._v("在应用中定义任务")]),s._v(" "),t("p",[s._v("在需要使用异步的"),t("code",[s._v("app")]),s._v("中定义一个叫"),t("code",[s._v("task.py")])]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 任务都写到应用中的task.py中")]),s._v("\n\n@ shared_task\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("my_task")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("pass")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"调用异步任务"}},[s._v("调用异步任务")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("my_task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("delay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("a"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("b"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"测试启动异步"}},[s._v("测试启动异步")]),s._v(" "),t("p",[s._v("启动celery 之前，需要启动redis")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("celery "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A deep_diary worker "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("loglevel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("P eventlet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("成功启动后，这边就会打印相关信息")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v(" -------------- celery@Blue v3.1.26.post2 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Cipater"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n---- **** -----\n--- * ***  * -- Windows-10-10.0.19041-SP0\n-- * - **** ---\n- ** ---------- "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("config"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n- ** ---------- ."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" app:         deep_diary:0x2586c07e340\n- ** ---------- ."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" transport:   redis://localhost:6379/2\n- ** ---------- ."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" results:     redis://localhost:6379/1\n- *** --- * --- ."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" concurrency: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("prefork"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n-- ******* ----\n--- ***** ----- "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("queues"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n -------------- ."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" celery           "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("exchange")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("celery"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("direct"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("key")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("celery\n\n\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("tasks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" imagekit.cachefiles.backends._generate_file\n  "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v(" library.task.send_email\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("h3",{attrs:{id:"错误"}},[s._v("错误")]),s._v(" "),t("h4",{attrs:{id:"async-与系统关键字冲突"}},[s._v("async 与系统关键字冲突")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v(" from kombu.async.timer "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" Entry, Timer as Schedule, to_timestamp, logger\n SyntaxError: invalid syntax\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("blockquote",[t("p",[t("a",{attrs:{href:"https://blog.csdn.net/qq_51236600/article/details/116681098",target:"_blank",rel:"noopener noreferrer"}},[s._v("报错”from kombu.async.timer import Entry, Timer as Schedule, to_timestamp, logger”_默&墨的博客-CSDN博客"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("把用到"),t("code",[s._v("async")]),s._v("的包，都换成"),t("code",[s._v("asynchronous")]),s._v("，或者更新版本")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[s._v("redis                         "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.3")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".4")]),s._v("\ncelery                        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.2")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".7")]),s._v("\ncelery"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("redis             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.0")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 弃用")]),s._v("\ndjango"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("redis                  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.2")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),s._v("\neventlet\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.33")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),s._v("\ncelery "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A deep_diary beat\ncelery "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("A deep_diary worker "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("loglevel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("P eventlet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("h4",{attrs:{id:"kombu-exceptions-encodeerror"}},[s._v("kombu.exceptions.EncodeError")]),s._v(" "),t("p",[s._v("kombu.exceptions.EncodeError: Object of type Img is not JSON serializable")]),s._v(" "),t("p",[s._v("措施")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# using serializer name")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下默认为`json`，需要改为pickle即可")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 另外值得注意的是，在新版本中，官方推荐用小写字母方式进行配置")]),s._v("\naccept_content "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'json'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pickle'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ntask_serializer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pickle'")]),s._v("\nresult_serializer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pickle'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h4",{attrs:{id:"raised-unexpected-valueerror-code-32000-message-already-known"}},[s._v("raised unexpected: ValueError({'code': -32000, 'message': 'already known'})")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\f"}},[s._v("\\f")]),s._v('ace\\jtask.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("268")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" upload_face_to_mcs\n    data "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" upload_file_pay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wallet_info, fc_obj.src.path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend\\utils\\mcs_storage.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" upload_file_pay\n    w3_api "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" approve_usdc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wallet_info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Usdc approve needs to be performed one step before payment.")]),s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend\\utils\\mcs_storage.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" approve_usdc\n    w3_api.approve_usdc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("wallet_info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'wallet_address'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(",\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("nv\\lib\\site-packages\\mcs"),t("span",{pre:!0,attrs:{class:"token entity",title:"\\c"}},[s._v("\\c")]),s._v('ontract\\mcs_contract.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" approve_usdc\n    tx_hash "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" self.w3.eth.sendRawTransaction"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("signed_tx.rawTransaction"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v("nv\\lib\\site-packages\\web3"),t("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v('th.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("831")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" send_raw_transaction\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" self._send_raw_transaction"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("transaction"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v('nv\\lib\\site-packages\\web3\\module.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("caller")]),s._v("\n    result "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" w3.manager.request_blocking"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("method_str,\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v('nv\\lib\\site-packages\\web3\\manager.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("198")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" request_blocking\n    "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("return")]),s._v(" self.formatted_response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("response,\n  File "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"D:\\BlueDoc\\DeepDiary\\Backend'),t("span",{pre:!0,attrs:{class:"token entity",title:"\\e"}},[s._v("\\e")]),s._v('nv\\lib\\site-packages\\web3\\manager.py"')]),s._v(", line "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("171")]),s._v(", "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" formatted_response\n    raise ValueError"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("response"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"error"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nValueError: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'code'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" -32000, "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'message'")]),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'already known'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("h3",{attrs:{id:"django-调用redis"}},[s._v("django 调用redis")]),s._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://blog.csdn.net/jiandanokok/article/details/109426427",target:"_blank",rel:"noopener noreferrer"}},[s._v("【Django】Redis的使用【原创】_jiandanokok的博客-CSDN博客"),t("OutboundLink")],1)])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("\npip "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" django-redis  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装django-redis模块")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("h2",{attrs:{id:"定时任务"}},[s._v("定时任务")]),s._v(" "),t("p",[s._v("配置文件")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置文件 celeryconfig.py")]),s._v("\n\nbroker_url "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://127.0.0.1:6379/2'")]),s._v("\nresult_backend "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'redis://127.0.0.1:6379/1'")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# using serializer name")]),s._v("\naccept_content "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'json'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pickle'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ntask_serializer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pickle'")]),s._v("\nresult_serializer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'pickle'")]),s._v("\n\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("配置")]),s._v(" "),t("div",{staticClass:"language-python line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-python"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" os\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Celery\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# project_name = os.path.split(os.path.abspath('.'))[-1]")]),s._v("\nproject_name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deep_diary'")]),s._v("\nproject_settings "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%s.settings'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" project_name\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置环境变量")]),s._v("\nos"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("environ"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("setdefault"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DJANGO_SETTINGS_MODULE'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" project_settings"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 实例化celery")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# broker = 'redis://127.0.0.1:6379/0'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# backend")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# backend = 'redis://127.0.0.1:6379/1'")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# worker")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app = Celery(broker=broker, backend=backend, include=['celery_task.tasks'])")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# app = Celery(project_name, broker=broker, backend=backend)")]),s._v("\napp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Celery"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("project_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用django 的配置文件进行配置")]),s._v("\napp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("config_from_object"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deep_diary.celeryconfig'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时区")]),s._v("\napp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("timezone "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Asia/Shanghai'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否使用UTC")]),s._v("\napp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("enable_utc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 任务的定时配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" datetime "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" timedelta\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" celery"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("schedules "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" crontab\n\napp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("conf"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("beat_schedule "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'check_all_img_info'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'task'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'library.task.check_all_img_info'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'schedule'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" timedelta"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'args'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("None")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("False")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# None here means represent deal with all the images")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 'args': (['get_exif_info'], [], False,),")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'test'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'task'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'library.task.test'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'schedule'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" timedelta"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'args'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'deep-diary is running'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br")])]),t("p",[s._v("运行")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("celery -A deep_diary.celery beat\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"服务器启动"}},[s._v("服务器启动")]),s._v(" "),t("p",[s._v("启动的时候报错了")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("venv_diary"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" root@deep-diary:/home/DeepDiary/Backend"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# celery -A deep_diary worker --loglevel=info -P eventlet")]),s._v("\nRunning a worker with superuser privileges when the\nworker accepts messages serialized with pickle is a very bad idea"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\n\nIf you really want to "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("continue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" you have to "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" the C_FORCE_ROOT\nenvironment variable "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("but please think about this before you "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n\nUser information: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("uid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("euid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("gid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("egid")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("解决措施")]),s._v(" "),t("p",[s._v("这个警告是由于您正在使用以超级用户权限（root 用户）运行 Celery worker，并且消息序列化方式设置为 pickle。这是不安全的操作，因为 pickle 可能存在安全漏洞，允许攻击者在反序列化时执行恶意代码。")]),s._v(" "),t("p",[s._v("要解决这个问题，最好的做法是不以超级用户权限运行 Celery worker，并且避免使用 pickle 序列化。您可以通过设置其他安全的序列化方式，如 JSON 或者 msgpack。")]),s._v(" "),t("p",[s._v("以下是一个示例命令，可以指定使用 JSON 序列化：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("celery -A deep_diary worker --loglevel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info -P eventlet -s /tmp/celery_state --without-gossip --without-mingle --without-heartbeat --with-threads\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这里的 "),t("code",[s._v("-s /tmp/celery_state")]),s._v(" 参数用于指定状态文件的位置。")]),s._v(" "),t("p",[s._v("如果您确实需要在以超级用户权限运行 Celery worker 时解决这个问题，您可以设置 "),t("code",[s._v("C_FORCE_ROOT")]),s._v(" 环境变量来继续。但是在这种情况下，请确保您充分了解潜在的安全风险，并谨慎进行操作。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("C_FORCE_ROOT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\ncelery -A deep_diary worker --loglevel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info -P eventlet\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("==使用此方法可以跑起来，不过后续尝试更换成json格式试试==")]),s._v(" "),t("p",[s._v("请注意，在生产环境中，不建议以超级用户权限运行 Celery worker 或使用 pickle 序列化。优先选择安全的方式来设置和运行 Celery 以保护您的应用程序和数据。")])])}),[],!1,null,null,null);a.default=n.exports}}]);