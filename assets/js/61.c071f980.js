(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{683:function(s,t,a){"use strict";a.r(t);var n=a(5),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("说明")]),s._v(" "),a("p",[s._v("对象存储"),a("code",[s._v("oss")]),s._v("可以简单理解为用来存储图片、音频、视频等非结构化数据的数据池。相对于主机服务器，具有读写速度快，利于分享的特点。本文主要分享下如何在"),a("code",[s._v("django")]),s._v("中使用阿里云"),a("code",[s._v("oss")])]),s._v(" "),a("p",[a("a",{attrs:{href:"www.deep-diary.com"}},[s._v("点击免费观看教学视频")])])]),s._v(" "),a("h1",{attrs:{id:"django-使用阿里云oss对象存储"}},[s._v("Django 使用阿里云oss对象存储")]),s._v(" "),a("p",[s._v("上一章我们实现了网站的域名绑定，可以通过域名进行网页访问，但有一个头疼的问题是，图片资源动不动就好几个M，加载一张图片等地真心累，这样用户早就跑完了。")]),s._v(" "),a("p",[s._v("关于网站优化，有如下几个方法：")]),s._v(" "),a("ol",[a("li",[s._v("将图片等媒体文件放到oss服务器上")]),s._v(" "),a("li",[s._v("将静态文件放到oss服务器上或者使用cdn服务器进行加载")])]),s._v(" "),a("p",[s._v("本章先简单介绍下oss服务器。")]),s._v(" "),a("h2",{attrs:{id:"什么是oss对象存储"}},[s._v("什么是oss对象存储")]),s._v(" "),a("p",[s._v("对象存储服务（Object Storage Service，简称 OSS）为您提供基于网络的数据存取服务。使用 OSS，您可以通过网络随时存储和调用包括文本、图片、音频和视频等在内的各种非结构化数据文件。")]),s._v(" "),a("h2",{attrs:{id:"为什么要使用oss对象存储"}},[s._v("为什么要使用oss对象存储")]),s._v(" "),a("p",[s._v("对象存储可以简单理解为用来存储图片、音频、视频等非结构化数据的数据池。相对于主机服务器，具有读写速度快，利于分享的特点y")]),s._v(" "),a("p",[s._v("阿里云OSS:海量、安全、低成本、高可靠的云存储服务，提供99.9999999999%的数据可靠性。使用RESTful API 可以在互联网任何位置存储和访问，容量和处理能力弹性扩展")]),s._v(" "),a("p",[s._v("1、网站数据动静分离，大幅提升网页性能")]),s._v(" "),a("p",[s._v("一般情况下，我们都是建议使用主机服务器和对象存储分工合作的方式来存储网站数据。主机服务器主要负责存储网站的动态数据，对象存储则用来存储网站的静态文件。从而实现网站的动静分离，当用户访问一个网站时，分别从主机服务器和对象存储的服务器同步读取数据，可以大幅的提升网页性能。")]),s._v(" "),a("p",[s._v("2、单独的文件管理界面，管理网站文件和本地电脑一样方便")]),s._v(" "),a("p",[s._v("无论是腾讯云、阿里云、杉岩，对象存储都有单独的管理控制台，腾讯云和阿里云还有专门的电脑客户端。你不必打开网站，就可以像使用百度云盘一样使用对象存储来管理你的网站文件，除了上传、下载、预览等常用功能，还可以直接在对象存储上进行图片处理/媒体转码/数据分析等。")]),s._v(" "),a("p",[s._v("3、本质是”内置大容量硬盘的分布式服务器“，同一个文件支持跨域共享")]),s._v(" "),a("p",[s._v("对象存储的本质是“内置大容量硬盘的分布式服务器”，对象存储有自己的 CPU、内存、网络和磁盘系统，具备一定的智能，同一个对象存储数据池可以新建不同的存储桶（bucket），分别用来存储不同网站的数据，彼此互不干扰。而且同一个文件可以引用到不同的网站，可以有效的减少数据冗余。")]),s._v(" "),a("p",[s._v("4、储存节点多，支持跨地域实时同步，实现异地容灾")]),s._v(" "),a("p",[s._v("假设你的图片等数据存储在你自己的服务器上，只能通过定期数据备份的方式保护你的数据。数据量大的话，每次备份都需要大量的时间和占用大量的磁盘空间，管理起来还不方便。")]),s._v(" "),a("p",[s._v("如果你的数据放置在对象存储的数据池了，并与网站关联。那么静态文件的备份就可以交给对象存储。你只需要对网站少量的动态文件进行备份。省时省力。")]),s._v(" "),a("p",[s._v("比如我使用对象存储，我在离我最近的节点【深圳】来存储网站的图片等静态文件。但是考虑到极端情况，比如深圳节点由于突然停电，可能导致数据全部丢失。但如果之前我选择了【杭州】作为第二个存储节点，而且设置【深圳】节点的数据实时增量同步到【杭州】节点。那么就算深圳节点的数据丢失了，但是我在杭州的数据还是可以使用。等到恢复供电，我再把数据从杭州节点同步回深圳节点就可以了。这就是我们说的异地容灾。")]),s._v(" "),a("p",[s._v("5、成本低，资源弹性伸缩，按需付费")]),s._v(" "),a("p",[s._v("对象存储不像服务器的流量是固定的，包含在服务器的费用里面了。无论你用或不用，都是这么多。对象存储可以是根据你的实际使用量进行计费。")]),s._v(" "),a("p",[s._v("6、节省服务器空间")]),s._v(" "),a("p",[s._v("为什么选择将这一点放在最后说呢？因为现在服务器的价格还算实惠，活动也比较多。大部分站长已经不存在服务器空间不够用的问题。而且对象存储的出现也不是为了解决服务器空间不够用的问题。而是为了结合【块存储】、【文件存储】各自的优点，从而实现高效的文件读写和分享。但是节省了服务器空间还是不争得事实，所以还是提一下吧。\n以上内容转载，原文详解末尾链接")]),s._v(" "),a("h2",{attrs:{id:"阿里云oss的相关配置"}},[s._v("阿里云oss的相关配置")]),s._v(" "),a("h3",{attrs:{id:"_1-创建bucket"}},[s._v("1. 创建bucket")]),s._v(" "),a("p",[s._v("这里的bucket就是所谓的存储空间，可以理解成云盘的根目录")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/1644409424161.png",alt:"1644409424161"}})]),s._v(" "),a("h3",{attrs:{id:"_2-配置bucket"}},[s._v("2. 配置Bucket")]),s._v(" "),a("p",[s._v("由于是个人网站，很多用户都可以查阅，因此这里的读写权限选择公共读。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/1644409506089.png",alt:"1644409506089"}})]),s._v(" "),a("h3",{attrs:{id:"_3-尝试手动上传文件到oss服务器"}},[s._v("3. 尝试手动上传文件到oss服务器")]),s._v(" "),a("p",[s._v("这里仅仅作为测试，后续肯定会用python实现自动上传相关媒体文件到服务器。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/1644409845284.png",alt:"1644409845284"}})]),s._v(" "),a("h3",{attrs:{id:"_4-尝试从服务器中获取照片"}},[s._v("4. 尝试从服务器中获取照片")]),s._v(" "),a("p",[a("strong",[s._v("示例代码")])]),s._v(" "),a("p",[s._v("以下代码用于将examplebucket中testfolder目录下的exampleobject.txt下载到本地D:\\localpath路径下的examplefile.txt。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -*- coding: utf-8 -*-")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" oss2\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 阿里云账号AccessKey拥有所有API的访问权限，风险很高。强烈建议您创建并使用RAM账号进行API访问或日常运维，请登录RAM控制台创建RAM账号。")]),s._v("\nauth "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yourAccessKeyId'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yourAccessKeySecret'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Endpoint以杭州为例，其它Region请按实际情况填写。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 填写Bucket名称，例如examplebucket。")]),s._v("\nbucket "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'http://oss-cn-hangzhou.aliyuncs.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'examplebucket'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 填写Object完整路径，完整路径中不包含Bucket名称，例如testfolder/exampleobject.txt。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载Object到本地文件，并保存到指定的本地路径D:\\\\localpath\\\\examplefile.txt。如果指定的本地文件存在会覆盖，不存在则新建。")]),s._v("\nbucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("get_object_to_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'testfolder/exampleobject.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'D:\\\\localpath\\\\examplefile.txt'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("这里的bucket，就是阿里云存储对象，有很多属性，也可以对这个对象进行分页操作，同时，这个对象也有很多方法，比如上传，下载图片等，具体详解文章末尾链接的官网教程")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/1644419847400.png",alt:"1644419847400"}})]),s._v(" "),a("h2",{attrs:{id:"django-配置阿里云oss"}},[s._v("Django 配置阿里云oss")]),s._v(" "),a("h3",{attrs:{id:"_1-安装依赖包"}},[s._v("1. 安装依赖包")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("pip install oss2\npip install django-oss-storage\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"_2-settings-py-中添加-oss-配置"}},[s._v("2. settings.py 中添加 oss 配置")]),s._v(" "),a("p",[s._v("以下配置完毕后就会生效, 上传地址, 访问路径都会变成 oss 服务器上的")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[s._v("MEDIA_URL "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/media/'")]),s._v("\nMEDIA_ROOT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("join"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("BASE_DIR"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'media'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nOSS_ACCESS_KEY_ID "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("  \nOSS_ACCESS_KEY_SECRET "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("   \nOSS_ENDPOINT "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"oss-accelerate.aliyuncs.com"')]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 访问域名, 根据服务器上的实际配置修改")]),s._v("\nOSS_BUCKET_NAME "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# oss 创建的 BUCKET 名称")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加下面配置后 Django admin 后台上传的 ImageField, FileField 类型的字段都会被自动上传到 oss 的服务器中, 访问路径也会自动替换# 如果注释掉的话 oss 的配置会失效, 上传文件会存储到本地, 且访问路径也会变成本地")]),s._v("\nDEFAULT_FILE_STORAGE "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'django_oss_storage.backends.OssMediaStorage'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"_3-文件上传路径说明"}},[s._v("3. 文件上传路径说明")]),s._v(" "),a("p",[s._v("如果开始设计的时候，是使用的本地media目录，现在无非就是把这个默认存储空间，转移到了阿里云bucket中的media目录，其它均可以保持不变。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/1645532036150.png",alt:"1645532036150"}})]),s._v(" "),a("h3",{attrs:{id:"_4-监听相关操作"}},[s._v("4. 监听相关操作")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    image "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("FileField"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("verbose_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"图片文件"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" upload_to"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"base/image/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" null"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" blank"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("True")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该表删除操作时监听")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@receiver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("post_delete"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Base"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("delete_upload_files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sender"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v("kwargs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除 oss仓库 图片")]),s._v("\n    files "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("getattr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'image'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接 oss ")]),s._v("\n    auth "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_ACCESS_KEY_ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_ACCESS_KEY_SECRET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取 bucket ")]),s._v("\n    bucket "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_ENDPOINT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_BUCKET_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除文件")]),s._v("\n    bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("delete_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该表更新/创建操作时监听")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[s._v("@receiver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("post_save"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sender"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Base"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("save_upload_files")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sender"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("**")]),s._v("kwargs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新 oss仓库 图片")]),s._v("\n    files "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("getattr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'image'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要对图片进行处理的样式")]),s._v("\nstyle1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image/crop,x_10,y_10,w_200,h_200,g_se"')]),s._v("\nstyle2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'image/resize,w_700,h_260,m_lfit'")]),s._v("\nstyle3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'image/resize,m_fixed,h_260,w_700'")]),s._v("\n\nauth "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_ACCESS_KEY_ID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_ACCESS_KEY_SECRET"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nbucket "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_ENDPOINT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_BUCKET_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nprocess "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{0}|sys/saveas,o_{1},b_{2}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                              oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("compat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("base64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("urlsafe_b64encode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n                                                  oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("compat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("file_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                                              oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("compat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("base64"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("urlsafe_b64encode"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n                                                  oss2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("compat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("to_bytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("settings"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("OSS_BUCKET_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新文件")]),s._v("\nbucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("process_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("files"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br")])]),a("h2",{attrs:{id:"issue-after-changing-to-oss"}},[s._v("Issue after changing to oss")]),s._v(" "),a("p",[s._v("at previous version,  before save the image, we fetch the image info during uploading. however, when change to oss as the default storage, absolute paths not been support any more, then comes an issues")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("user_directory_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dir struct MEDIA/user/subfolder/%Y/%m/%d/file")]),s._v("\n    sub_folder "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"img"')]),s._v("\n    date_str "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'1970:01:01 00:00:00'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'INFO: instance.user.username！'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# print(f'instance.src.path: {instance.src.path}')  # raise NotImplementedError(\"This backend doesn't support absolute paths.\")      <-------open this code, uploading will be failed")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v("f'instance.src.url:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v("f'instance.src.name:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string-interpolation"}},[a("span",{pre:!0,attrs:{class:"token string"}},[s._v("f'instance.src:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# p = Image.open(instance.src)  # 创建图像实例     <-------open this code, uploading will be failed")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# if p._getexif() and 36867 in p._getexif():")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     date_str = p._getexif()[36867]  # 获取时间戳")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     print('照片日期：' + date_str)  # 照片日期：2021:07:31 18:13:31")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# else:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     print('INFO: 未找到时间信息！')")]),s._v("\n\n\n    tt "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("strptime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("date_str"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'%Y:%m:%d %H:%M:%S'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# date_path = os.path.join(str(tt.year), str(tt.month), str(tt.day))")]),s._v("\n\n    instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" filename\n    instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# instance = get_img_info(instance)  # 本打算在这里获取更多的图片元数据，但是这里的实例还没保存，图片路径还不存在")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'unauthorized'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user_img_path = os.path.join(instance.user.username, sub_folder, date_path, filename)  # 生成照片保存的路径")]),s._v("\n    user_img_path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{0}/{1}/{2}/{3}/{4}/{5}'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sub_folder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("year"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("month"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" tt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("day"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'照片存放路径为：'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" user_img_path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dir struct MEDIA/user/subfolder/%Y/%m/%d/file")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" user_img_path\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h3",{attrs:{id:"solution"}},[s._v("solution")]),s._v(" "),a("p",[s._v("since we already manage the image by database, so there is no necessary to manage the image through date folder any more. then, I made a decision that store the image only by "),a("code",[s._v("Username/img/filename")]),s._v(", while the previous is "),a("code",[s._v("Username/img/year/month/day/filename")]),s._v(", let's do it (2022/11/26)")]),s._v(" "),a("p",[s._v("after this decision, the "),a("code",[s._v("user_directory_path")]),s._v("function will be more easier")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("def")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("user_directory_path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dir struct MEDIA/user/subfolder/file")]),s._v("\n    sub_folder "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"img"')]),s._v("\n    instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" filename\n    instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("type")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'.'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("not")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'unauthorized'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# os.path.join will be wrong: blue\\img\\1970\\1\\1\\avatar.jpg")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# user_img_path = os.path.join(instance.user.username, sub_folder, date_path, filename)  ")]),s._v("\n    user_img_path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{0}/{1}/{2}'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("format")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sub_folder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'照片存放路径为：'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" user_img_path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# dir struct MEDIA/user/subfolder/file")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" user_img_path\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"server-config-oss"}},[s._v("Server config oss")]),s._v(" "),a("h3",{attrs:{id:"install-django-oss-storage"}},[s._v("install django_oss_storage")]),s._v(" "),a("p",[s._v("before install the package, we need to active the "),a("code",[s._v("(venv_diary)")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("venv_diary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" root@deep-diary:/home/venv_diary"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pip install django_oss_storage")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"delete-previous-static-folder-in-oss"}},[s._v("delete previous static folder in oss")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/image-20221126201624644.png",alt:"image-20221126201624644"}})]),s._v(" "),a("h3",{attrs:{id:"collect-the-static-file-in-server"}},[s._v("collect the static file in server")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("venv_diary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" root@deep-diary:/home/Backend"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# python3 manage.py collectstatic")]),s._v("\n\nYou have requested to collect static files at the destination\nlocation as specified "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" your settings.\n\nThis will overwrite existing files"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("\nAre you sure you want to "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("do")]),s._v(" this?\n\nType "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'yes'")]),s._v(" to continue, or "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'no'")]),s._v(" to cancel: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1964")]),s._v(" static files copied.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("venv_diary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" root@deep-diary:/home/Backend"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("after this command, project will collect all the static files, which include backend and frontend, to the oss "),a("code",[s._v("/static")])]),s._v(" "),a("h3",{attrs:{id:"run-and-test"}},[s._v("Run and Test")]),s._v(" "),a("p",[s._v("cool, the static file already existed in the oss server, the most exciting time is coming, start the project by using the below command")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("venv_diary"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" root@deep-diary:/home/Backend"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# gunicorn --bind unix:/tmp/www.deep-diary.com.socket deep_diary.wsgi:application")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-11-26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":31:25 +0800"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("612693")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting gunicorn "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.1")]),s._v(".0\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-11-26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":31:25 +0800"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("612693")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Listening at: unix:/tmp/www.deep-diary.com.socket "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("612693")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-11-26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":31:25 +0800"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("612693")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Using worker: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sync")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-11-26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":31:25 +0800"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("612695")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("INFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Booting worker with pid: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("612695")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("even though there is not much resource in this website now. but it is starting working now. this is a big step.")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://deep-diary.oss-cn-hangzhou.aliyuncs.com/blog/image-20221126204008393.png",alt:"image-20221126204008393"}})]),s._v(" "),a("h2",{attrs:{id:"next-step"}},[s._v("Next Step")]),s._v(" "),a("ul",[a("li",[s._v("improve the http to https")]),s._v(" "),a("li",[s._v("add the proces model to tracking what have been down for fetching the email")]),s._v(" "),a("li",[s._v("enlarge the serve memory, at this moment, we couldn't upload the image this is website since the face recognition need nearly 700M memory. the ECS total have 2G, and will be run out.")]),s._v(" "),a("li",[s._v("improve the graph note and edge description.")]),s._v(" "),a("li",[s._v("make a link between blog and gallery")])]),s._v(" "),a("p",[s._v("Due to the impact of the epidemic, our company, as well as our town are lock down since this Monday.  the most important thing that I have down those days, is finishing deployment this project. cool!")]),s._v(" "),a("p",[s._v("2022-11-26 20:46")]),s._v(" "),a("h2",{attrs:{id:"小结"}},[s._v("小结")]),s._v(" "),a("p",[s._v("现在图片等媒体文件可以上传到oss对象服务器了，是不是网站的访问速度就可以大大提高了呢？答案是有一定的作用，但还可以优化提速。")]),s._v(" "),a("p",[s._v("我们知道服务器加载静态资源还是蛮费时间的，学习了本章，是否可以考虑把静态资源也搬到oss上呢？")]),s._v(" "),a("p",[s._v("另外CDN也可以加快网站的访问速度，但具体快多少呢？下一节将揭晓答案。")]),s._v(" "),a("h2",{attrs:{id:"扩展阅读"}},[s._v("扩展阅读")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://gosspublic.alicdn.com/image/index.html?spm=a2c4g.11186623.0.0.7d203871dQExI3",target:"_blank",rel:"noopener noreferrer"}},[s._v("OSS图片处理6.0 (alicdn.com)"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://help.aliyun.com/document_detail/47660.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("OSS SDK 图片处理 (aliyun.com)"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/Doudou_Mylove/article/details/107221109",target:"_blank",rel:"noopener noreferrer"}},[s._v("为什么需要使用oss对象存储"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("[Django 配置阿里云oss]( "),a("a",{attrs:{href:"https://www.cnblogs.com/chaoqi/p/13903371.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("python - Django 配置阿里云 oss - _Q - 博客园 (cnblogs.com)"),a("OutboundLink")],1),s._v(" )")])])}),[],!1,null,null,null);t.default=e.exports}}]);